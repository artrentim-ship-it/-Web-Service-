import os
import json
from flask import Flask, request, jsonify, render_template_string
from flask_cors import CORS
import google.generativeai as genai
import logging

# Configuração básica de logging
logging.basicConfig(level=logging.INFO)

app = Flask(__name__)
# Configuração do CORS para permitir acesso externo
CORS(app, resources={r"/*": {"origins": "*"}})

# --- Configuração do Gemini ---
# A chave da API deve ser configurada na variável de ambiente do servidor
api_key = os.environ.get("GOOGLE_GENAI_API_KEY")
model = None

def inicializar_modelo():
    global model
    if api_key:
        try:
            genai.configure(api_key=api_key)
            
            # --- MANUAL DE REGRAS (System Instruction) ---
            system_instruction = """
            **MANUAL DE REGRAS - ASSISTENTE CLÍNICO DR. ANTONIO RAÍ TRENTIM**
            Você é o assistente do Dr. Antonio Raí Trentim, CRM 170197, Psiquiatra e Médico de Família.
            Seu objetivo é auxiliar o Dr. Trentim, respondendo perguntas sobre raciocínio clínico, 
            diagnósticos diferenciais e planos de tratamento.
            Sua análise deve ser profunda e clínica.
            Em farmacologia, considere o mundo real, mas alerte sobre doses e interações importantes.
            Sempre foque na Medicina Centrada na Pessoa.
            **Lembre-se: Você não diagnostica, não prescreve e não substitui o médico.** Sua função é ser um "segundo cérebro" para o Dr. Trentim, ajudando-o a pensar.
            Responda de forma direta e informativa, como um assistente sênior.
            """
            
            model = genai.GenerativeModel(
                model_name="gemini-pro",
                system_instruction=system_instruction
            )
            app.logger.info("Modelo Gemini (Chatbot) inicializado com sucesso.")
        
        except Exception as e:
            app.logger.error(f"Erro ao inicializar Gemini: {e}")
            model = None
    else:
        # Aviso se a API Key não estiver configurada
        app.logger.warning("Variável de ambiente GOOGLE_GENAI_API_KEY não configurada.")
        model = None

inicializar_modelo()

# --- Interface Web (Aparência e Funcionalidade do Site) ---
HTML_TEMPLATE = """
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assistente Clínico Dr. Antonio Raí Trentim</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100%;
            color: #333;
        }

        html, body {
            height: 100%;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100%;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            text-align: center;
        }

        .header h1 {
            color: #2c3e50;
            margin: 0 0 10px 0;
            font-size: 2.2em;
            font-weight: 700;
        }

        .header .subtitle {
            color: #7f8c8d;
            font-size: 1.1em;
            margin: 0;
        }

        .crm-info {
            background: #e8f4fd;
            color: #2980b9;
            padding: 8px 16px;
            border-radius: 20px;
            display: inline-block;
            font-size: 0.9em;
            font-weight: 500;
            margin-top: 10px;
        }

        .chat-container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            max-height: 75vh; 
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #fafafa;
        }

        .message {
            margin-bottom: 20px;
            animation: fadeIn 0.3s ease-in;
        }

        .message.user {
            text-align: right;
        }

        .message.assistant {
            text-align: left;
        }

        .message-bubble {
            display: inline-block;
            max-width: 80%;
            padding: 15px 20px;
            border-radius